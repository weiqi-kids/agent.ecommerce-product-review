name: Validate SEO

on:
  push:
    paths:
      - 'docs/Narrator/**/*.md'
  pull_request:
    paths:
      - 'docs/Narrator/**/*.md'
  workflow_dispatch:
  schedule:
    # æ¯é€±ä¸€ UTC 00:00 åŸ·è¡Œå®Œæ•´æª¢æŸ¥
    - cron: '0 0 * * 1'

permissions:
  contents: write
  issues: write

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      has_errors: ${{ steps.validate.outputs.has_errors }}
      error_count: ${{ steps.validate.outputs.error_count }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate SEO
        id: validate
        run: |
          set +e
          node scripts/validate-seo.js --json > validation-result.json 2>&1
          EXIT_CODE=$?
          set -e

          # è§£æçµæœ
          FAILED=$(jq -r '.failed' validation-result.json)
          WARNINGS=$(jq -r '.warnings' validation-result.json)
          TOTAL=$(jq -r '.total' validation-result.json)

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

          if [ "$FAILED" -gt 0 ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
            echo "error_count=$FAILED" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
            echo "error_count=0" >> $GITHUB_OUTPUT
          fi

          # é¡¯ç¤ºçµæœ
          echo "### SEO é©—è­‰çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | æ•¸é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ç¸½æª”æ¡ˆæ•¸ | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| éŒ¯èª¤ | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| è­¦å‘Š | $WARNINGS |" >> $GITHUB_STEP_SUMMARY

          if [ "$FAILED" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### âŒ éŒ¯èª¤æª”æ¡ˆ" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            jq -r '.files[] | select(.errors | length > 0) | "\(.file): \(.errors | map(.message) | join(", "))"' validation-result.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload validation result
        uses: actions/upload-artifact@v4
        with:
          name: validation-result
          path: validation-result.json

  auto-fix:
    needs: validate
    if: needs.validate.outputs.has_errors == 'true'
    runs-on: ubuntu-latest
    outputs:
      fix_success: ${{ steps.fix.outputs.success }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Auto-fix SEO issues
        id: fix
        run: |
          echo "ğŸ”§ å˜—è©¦è‡ªå‹•ä¿®å¾© SEO å•é¡Œ..."
          node scripts/fix-seo.js

          # é‡æ–°é©—è­‰
          set +e
          node scripts/validate-seo.js --json > post-fix-result.json 2>&1
          set -e

          FAILED=$(jq -r '.failed' post-fix-result.json)

          if [ "$FAILED" -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰€æœ‰å•é¡Œå·²è‡ªå‹•ä¿®å¾©ï¼"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ ä»æœ‰ $FAILED å€‹å•é¡Œéœ€è¦æ‰‹å‹•è™•ç†"
          fi

      - name: Commit fixes
        if: steps.fix.outputs.success == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add -A
          if git diff --staged --quiet; then
            echo "æ²’æœ‰éœ€è¦æäº¤çš„è®Šæ›´"
          else
            git commit -m "fix(seo): è‡ªå‹•ä¿®å¾© SEO å•é¡Œ

            Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
            git push
          fi

      - name: Upload post-fix result
        uses: actions/upload-artifact@v4
        with:
          name: post-fix-result
          path: post-fix-result.json

  create-issue:
    needs: [validate, auto-fix]
    if: always() && needs.validate.outputs.has_errors == 'true' && needs.auto-fix.outputs.fix_success != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download validation result
        uses: actions/download-artifact@v4
        with:
          name: post-fix-result
          path: .
        continue-on-error: true

      - name: Download original validation result
        if: failure()
        uses: actions/download-artifact@v4
        with:
          name: validation-result
          path: .

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate issue body
        id: issue
        run: |
          # è®€å–é©—è­‰çµæœ
          if [ -f post-fix-result.json ]; then
            RESULT_FILE="post-fix-result.json"
          else
            RESULT_FILE="validation-result.json"
          fi

          FAILED=$(jq -r '.failed' $RESULT_FILE)
          TOTAL=$(jq -r '.total' $RESULT_FILE)

          # ç”Ÿæˆ issue å…§å®¹
          cat > issue-body.md << 'EOF'
          ## ğŸš¨ SEO é©—è­‰å¤±æ•—

          è‡ªå‹•ä¿®å¾©ç„¡æ³•è§£æ±ºæ‰€æœ‰å•é¡Œï¼Œéœ€è¦äººå·¥ä»‹å…¥ã€‚

          ### çµ±è¨ˆ
          | é …ç›® | æ•¸é‡ |
          |------|------|
          | ç¸½æª”æ¡ˆæ•¸ | TOTAL_PLACEHOLDER |
          | éŒ¯èª¤æª”æ¡ˆ | FAILED_PLACEHOLDER |

          ### éŒ¯èª¤è©³æƒ…

          EOF

          sed -i "s/TOTAL_PLACEHOLDER/$TOTAL/g" issue-body.md
          sed -i "s/FAILED_PLACEHOLDER/$FAILED/g" issue-body.md

          # æ·»åŠ éŒ¯èª¤è©³æƒ…
          echo '```' >> issue-body.md
          jq -r '.files[] | select(.errors | length > 0) | "ğŸ“ \(.file)\n\(.errors | map("   âŒ [\(.field)] \(.message)") | join("\n"))\n"' $RESULT_FILE >> issue-body.md
          echo '```' >> issue-body.md

          # æ·»åŠ ä¿®å¾©å»ºè­°
          cat >> issue-body.md << 'EOF'

          ### ä¿®å¾©å»ºè­°

          1. **æœªé—œé–‰çš„ div æ¨™ç±¤**
             - æª¢æŸ¥ `<div class="comparison-table">` æˆ– `<div class="actionable-steps">` æ˜¯å¦æœ‰å°æ‡‰çš„ `</div>`
             - åœ¨è¡¨æ ¼/å€å¡ŠçµæŸå¾Œï¼ˆ`---` æˆ– `##` ä¹‹å‰ï¼‰åŠ ä¸Š `</div>`

          2. **< ç¬¦è™Ÿè§£æå•é¡Œ**
             - å°‡ `< 100` æ”¹ç‚º `å°æ–¼ 100`

          3. **YAML å†’è™Ÿå•é¡Œ**
             - å°‡å«å†’è™Ÿçš„ title ç”¨å¼•è™ŸåŒ…èµ·ä¾†ï¼š`title: "æ¨™é¡Œï¼šå‰¯æ¨™é¡Œ"`

          4. **ç¼ºå°‘ AI Tags**
             - ç¢ºä¿æ¯ç¯‡å ±å‘Šéƒ½æœ‰ `<div class="article-summary">` æ¨™ç±¤

          ### è‡ªå‹•ä¿®å¾©æŒ‡ä»¤

          ```bash
          node scripts/fix-seo.js
          node scripts/validate-seo.js
          ```

          ---
          ğŸ¤– æ­¤ Issue ç”± GitHub Actions è‡ªå‹•å»ºç«‹
          EOF

          echo "body_file=issue-body.md" >> $GITHUB_OUTPUT

      - name: Check for existing issue
        id: check_issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING=$(gh issue list --label "seo-validation" --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING" ]; then
            echo "existing_issue=$EXISTING" >> $GITHUB_OUTPUT
            echo "has_existing=true" >> $GITHUB_OUTPUT
          else
            echo "has_existing=false" >> $GITHUB_OUTPUT
          fi

      - name: Update existing issue
        if: steps.check_issue.outputs.has_existing == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.check_issue.outputs.existing_issue }} \
            --body-file issue-body.md

          echo "å·²æ›´æ–°ç¾æœ‰ Issue #${{ steps.check_issue.outputs.existing_issue }}"

      - name: Create new issue
        if: steps.check_issue.outputs.has_existing != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ğŸš¨ SEO é©—è­‰å¤±æ•— - éœ€è¦äººå·¥è™•ç†" \
            --body-file issue-body.md \
            --label "seo-validation,bug,automated"

          echo "å·²å»ºç«‹æ–° Issue"

  notify-success:
    needs: [validate, auto-fix]
    if: always() && (needs.validate.outputs.has_errors != 'true' || needs.auto-fix.outputs.fix_success == 'true')
    runs-on: ubuntu-latest

    steps:
      - name: Success summary
        run: |
          echo "### âœ… SEO é©—è­‰é€šé" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.auto-fix.outputs.fix_success }}" == "true" ]; then
            echo "å•é¡Œå·²è‡ªå‹•ä¿®å¾©ä¸¦æäº¤ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "æ‰€æœ‰å ±å‘Šçš„ SEO è¨­å®šæ­£ç¢ºã€‚" >> $GITHUB_STEP_SUMMARY
          fi
