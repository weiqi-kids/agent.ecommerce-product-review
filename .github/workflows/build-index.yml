name: Build index.json

on:
  push:
    paths:
      - 'docs/Extractor/**/*.md'
      - 'docs/Narrator/**/*.md'
  workflow_dispatch:

jobs:
  build-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Build Extractor index.json
        run: |
          for layer_dir in docs/Extractor/*/; do
            layer_name="$(basename "$layer_dir")"
            index_file="${layer_dir}index.json"
            echo "üìã Building index: $layer_name"

            items="[]"

            while IFS= read -r md_file; do
              [ -z "$md_file" ] && continue

              rel_path="${md_file#${layer_dir}}"
              title="$(grep -m1 '^# ' "$md_file" 2>/dev/null | sed 's/^# //' || echo "")"
              category="$(dirname "$rel_path")"
              [ "$category" = "." ] && category="other"

              # Âæû L1 Ë°®Ê†ºÊèêÂèñÊ¨Ñ‰Ωç
              product_id="$(grep -m1 '\*\*product_id\*\*' "$md_file" 2>/dev/null | sed 's/.*| *//; s/ *|.*//' || echo "")"
              brand="$(grep -m1 '\*\*Brand\*\*' "$md_file" 2>/dev/null | sed 's/.*| *//; s/ *|.*//' || echo "")"
              platform="$(grep -m1 '\*\*Platform\*\*' "$md_file" 2>/dev/null | sed 's/.*| *//; s/ *|.*//' || echo "")"
              avg_rating="$(grep -m1 '\*\*Avg Rating\*\*' "$md_file" 2>/dev/null | sed 's/.*| *//; s/ *(.*//' || echo "")"
              review_count="$(grep -m1 '\*\*Reviews Analyzed\*\*' "$md_file" 2>/dev/null | sed 's/.*| *//; s/ *|.*//' || echo "")"

              items="$(echo "$items" | jq \
                --arg title "$title" \
                --arg file "$rel_path" \
                --arg category "$category" \
                --arg product_id "$product_id" \
                --arg brand "$brand" \
                --arg platform "$platform" \
                --arg avg_rating "$avg_rating" \
                --arg review_count "$review_count" \
                --arg layer "$layer_name" \
                '. + [{
                  id: ($file | gsub("[/.]"; "-")),
                  title: $title,
                  category: $category,
                  product_id: $product_id,
                  brand: $brand,
                  platform: $platform,
                  avg_rating: $avg_rating,
                  review_count: $review_count,
                  file: $file,
                  source_layer: $layer
                }]'
              )"
            done < <(find "$layer_dir" -name "*.md" -not -path "*/raw/*" -type f 2>/dev/null | sort -r)

            echo "$items" | jq '.' > "$index_file"
            echo "‚úÖ $layer_name: $(echo "$items" | jq 'length') Á≠Ü"
          done

      - name: Build Narrator index.json
        run: |
          for mode_dir in docs/Narrator/*/; do
            mode_name="$(basename "$mode_dir")"
            index_file="${mode_dir}index.json"
            echo "üìã Building index: $mode_name"

            items="[]"

            while IFS= read -r md_file; do
              [ -z "$md_file" ] && continue

              rel_path="${md_file#${mode_dir}}"
              title="$(grep -m1 '^# ' "$md_file" 2>/dev/null | sed 's/^# //' || echo "")"

              # ÂæûÊ™îÂêçÊèêÂèñ product_id
              product_id="$(echo "$rel_path" | grep -oE '^[A-Z0-9]+' || echo "")"
              date_val="$(echo "$rel_path" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' || echo "")"

              items="$(echo "$items" | jq \
                --arg title "$title" \
                --arg date "$date_val" \
                --arg file "$rel_path" \
                --arg product_id "$product_id" \
                --arg mode "$mode_name" \
                '. + [{
                  id: ($file | gsub("[/.]"; "-")),
                  title: $title,
                  date: $date,
                  product_id: $product_id,
                  file: $file,
                  source_mode: $mode
                }]'
              )"
            done < <(find "$mode_dir" -name "*.md" -type f 2>/dev/null | sort -r)

            echo "$items" | jq '.' > "$index_file"
            echo "‚úÖ $mode_name: $(echo "$items" | jq 'length') Á≠Ü"
          done

      - name: Commit index.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/*/index.json docs/*/*/index.json
          if git diff --cached --quiet; then
            echo "No changes to index.json"
          else
            git commit -m "chore: auto-update index.json"
            git push
          fi
