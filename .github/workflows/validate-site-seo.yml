name: Validate Site SEO

on:
  # åœ¨ VitePress éƒ¨ç½²å®Œæˆå¾Œè§¸ç™¼
  workflow_run:
    workflows: ["Deploy VitePress to GitHub Pages"]
    types:
      - completed
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
  # æ¯é€±ä¸€ UTC 01:00 åŸ·è¡Œå®Œæ•´æª¢æŸ¥
  schedule:
    - cron: '0 1 * * 1'

permissions:
  contents: read
  issues: write

jobs:
  validate-site:
    runs-on: ubuntu-latest
    # åªåœ¨éƒ¨ç½²æˆåŠŸå¾ŒåŸ·è¡Œ
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for deployment propagation
        if: github.event_name == 'workflow_run'
        run: |
          echo "ç­‰å¾… 30 ç§’è®“éƒ¨ç½²ç”Ÿæ•ˆ..."
          sleep 30

      - name: Validate site SEO
        id: validate
        run: |
          set +e
          node scripts/validate-site.js --save 2>&1 | tee validation-output.txt
          EXIT_CODE=$?
          set -e

          # è§£æçµæœ
          if [ -f site-validation-result.json ]; then
            TOTAL=$(jq -r '.total' site-validation-result.json)
            PASSED=$(jq -r '.passed' site-validation-result.json)
            FAILED=$(jq -r '.failed' site-validation-result.json)
            WARNINGS=$(jq -r '.withWarnings' site-validation-result.json)
          else
            TOTAL=0
            PASSED=0
            FAILED=1
            WARNINGS=0
          fi

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

          if [ "$FAILED" -gt 0 ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

          # ç”Ÿæˆ Summary
          echo "### ğŸŒ å…¨ç«™ SEO é©—è­‰çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | æ•¸é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ç¸½é é¢æ•¸ | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… é€šé | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ å¤±æ•— | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ æœ‰è­¦å‘Š | $WARNINGS |" >> $GITHUB_STEP_SUMMARY

          if [ "$FAILED" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### âŒ éŒ¯èª¤é é¢" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            jq -r '.errors[] | "ğŸ“„ \(.url | split("/") | last)\n\(.errors | map("   âŒ [\(.type)] \(.message)") | join("\n"))"' site-validation-result.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          exit $EXIT_CODE

      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: site-validation-result
          path: |
            site-validation-result.json
            validation-output.txt

  create-issue:
    needs: validate-site
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download validation result
        uses: actions/download-artifact@v4
        with:
          name: site-validation-result
          path: .

      - name: Generate issue body
        id: issue
        run: |
          if [ ! -f site-validation-result.json ]; then
            echo "æ²’æœ‰é©—è­‰çµæœæª”æ¡ˆ"
            exit 0
          fi

          FAILED=$(jq -r '.failed' site-validation-result.json)
          TOTAL=$(jq -r '.total' site-validation-result.json)

          cat > issue-body.md << 'HEREDOC'
          ## ğŸŒ å…¨ç«™ SEO é©—è­‰å¤±æ•—

          å·²éƒ¨ç½²çš„ç¶²ç«™æœ‰ SEO å•é¡Œéœ€è¦ä¿®å¾©ã€‚

          ### çµ±è¨ˆ
          | é …ç›® | æ•¸é‡ |
          |------|------|
          | ç¸½é é¢æ•¸ | TOTAL_PLACEHOLDER |
          | éŒ¯èª¤é é¢ | FAILED_PLACEHOLDER |

          ### éŒ¯èª¤è©³æƒ…

          HEREDOC

          sed -i "s/TOTAL_PLACEHOLDER/$TOTAL/g" issue-body.md
          sed -i "s/FAILED_PLACEHOLDER/$FAILED/g" issue-body.md

          echo '```' >> issue-body.md
          jq -r '.errors[] | "ğŸ“„ \(.url | split("/") | last)\n\(.errors | map("   âŒ [\(.type)] \(.field // "") \(.message)") | join("\n"))\n"' site-validation-result.json >> issue-body.md
          echo '```' >> issue-body.md

          cat >> issue-body.md << 'HEREDOC'

          ### é©—è­‰é …ç›®

          - **Meta Tags**: title, description, keywords, og:*, twitter:*
          - **JSON-LD Schema**: Article, WebSite, Organization
          - **AI Tags**: article-summary (å¿…è¦), key-answer, key-takeaway (å»ºè­°)
          - **HTML**: lang å±¬æ€§, canonical link

          ### æœ¬åœ°é©—è­‰æŒ‡ä»¤

          ```bash
          npm run seo:validate-site
          ```

          ---
          ğŸ¤– æ­¤ Issue ç”± GitHub Actions è‡ªå‹•å»ºç«‹
          HEREDOC

      - name: Check for existing issue
        id: check_issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING=$(gh issue list --label "site-seo-validation" --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING" ]; then
            echo "existing_issue=$EXISTING" >> $GITHUB_OUTPUT
            echo "has_existing=true" >> $GITHUB_OUTPUT
          else
            echo "has_existing=false" >> $GITHUB_OUTPUT
          fi

      - name: Update existing issue
        if: steps.check_issue.outputs.has_existing == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.check_issue.outputs.existing_issue }} \
            --body-file issue-body.md
          echo "å·²æ›´æ–°ç¾æœ‰ Issue #${{ steps.check_issue.outputs.existing_issue }}"

      - name: Create new issue
        if: steps.check_issue.outputs.has_existing != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ğŸŒ å…¨ç«™ SEO é©—è­‰å¤±æ•— - éœ€è¦ä¿®å¾©" \
            --body-file issue-body.md \
            --label "site-seo-validation,bug,automated"
          echo "å·²å»ºç«‹æ–° Issue"
